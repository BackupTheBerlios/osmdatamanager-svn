<html>
<head>
	<title>OSM Datamanager</title>
	
	<style type="text/css">
		@import "styles.css";
		@import "lib/dojo/dijit/themes/tundra/tundra.css";	
		@import "lib/dojo/dojox/image/resources/image.css";
		@import "lib/dojo/dojox/widget/SortList/SortList.css";	
		@import "lib/dojo/dojox/grid/resources/Grid.css";
    	@import "lib/dojo/dojox/grid/resources/nihiloGrid.css";
		
		@import "lib/trm/trm.css";
		@import "lib/trm/login/Form.css";
		@import "lib/trm/widget/ItemManager.css";
		@import "lib/trm/widget/GroupDialog.css";
		@import "lib/trm/widget/PoiDialog.css";
		@import "lib/trm/widget/UserDialog.css";
	</style>
	
	<script type="test/javascript">djConfig = { isDebug: true };</script> 
	<script type="text/javascript" src="lib/dojo/dojo/dojo.js" djConfig="parseOnLoad:false"></script>			
			
	<script type="text/javascript">	
		  dojo.require("dojo.parser");
                    
		  
		  dojo.addOnLoad(function(){
				dojo.registerModulePath("trm","../../trm");		
				dojo.requireLocalization("trm", "popupmenu");
						
				
						
				//dojo.require("dojox.widget.SortList");
				dojo.require("dijit.layout.ContentPane");
			  	dojo.require("dijit.layout.BorderContainer");
				dojo.require("dijit.form.Button");
				dojo.require("dijit.Dialog");
				dojo.require("dijit.Menu");
				dojo.require("dijit.form.TextBox");
				//dojo.require("dijit.form.ValidationTextBox");
		   		dojo.require("dojox.validate.regexp");
		   		dojo.require("dojo.parser");
				dojo.require("dojo.data.ItemFileReadStore"); 
				dojo.require("dojox.image.ThumbnailPicker");
				dojo.require("dijit.form.CheckBox");
				//dojo.require("dijit.form.NumberSpinner");	
				dojo.require("dijit.form.Textarea");
				
				dojo.require("dojox.grid.DataGrid");
				dojo.require("dojox.grid.compat.Grid");
				dojo.require("dojox.data.CsvStore");
				dojo.require("dojox.grid.compat._data.model");
				dojo.require("dojo.dnd.Source"); 
				dojo.require("dojo.string");
				
				dojo.require("dojo.dnd.Mover");
  				dojo.require("dojo.dnd.Moveable");
  				dojo.require("dojo.dnd.move");
				
				dojo.require("dojo.data.ItemFileWriteStore");
  				dojo.require("dijit.tree.ForestStoreModel");
  				dojo.require("dijit._tree.dndSource");
  				dojo.require("dijit.Tree");
				
				//trm widgets
				//dojo.require("trm.login.Form");
				dojo.require("trm.login.Form");
				dojo.require("trm.translation.tt");
				dojo.require("trm.Button.TrmButton");
				dojo.require("trm.MenuItem.TrmMenuItem");
				dojo.require("trm.widget.ItemManager");
				dojo.require("trm.widget.GroupDialog");
				dojo.require("trm.widget.PoiDialog");	
				dojo.require("trm.widget.UserDialog");	
								
				dojo.parser.parse();   
                dojo.fadeOut({ 
                      node:"overlay",
                      onEnd: function(){ 
                             // hide it completely after fadeout
                             dojo.style("overlay","display","none");
                      }
                }).play();
				init();
          });

		
	</script>
	
	<script src="http://openlayers.org/api/OpenLayers.js"></script>
	<script src="http://www.openstreetmap.org/openlayers/OpenStreetMap.js"></script>	
		
	<!-- Project Files -->
	<script src="lib/trm/openlayers_extensions.js"></script>
	<script src="lib/trm/Application.js"></script>
	<script src="lib/trm/DijitClient.js"></script>
	<!-- <script src="lib/trm/GroupTree.js"></script> -->
	<script src="lib/trm/GroupManager.js"></script>
	<script src="lib/trm/PoiManager.js"></script>
	<script src="lib/trm/Markermanager.js"></script>
	
	<script src="json2.js"></script>		
	
	
	<script type="text/javascript" language="Javascript">
		dojo.provide("my.ForestStoreModel");
		dojo.require("dijit.Tree");
		
		dojo.declare("my.ForestStoreModel", dijit.tree.ForestStoreModel, {
			getChildren: function(parentItem, complete_cb, error_cb) {
				//alert(parentItem);
				console.debug(parentItem);
				if (parentItem.root == true) {
					// get top level nodes for this plugin id 
					pid = 5;
				}
				else {
					pid = this.store.getValue(parentItem, 'itemid');
				}
				this.store.fetch({ query: {itemid: pid}, 
								   onComplete: complete_cb, 
								   onError: error_cb});
	 
				// Call superclasses' getChildren
				return this.inherited(arguments);
			}
		});
		dojo.require("my.ForestStoreModel");
	</script>
	
	
	<script type="text/javascript">
				
		var gl_map;  				//openlayers map
		var gl_markers;				//marker layer
		//var gl_groupmanager = null; 
		var gl_dblclick = null;
		var gl_application=null;	//client application
		var gl_idx = 0;
		var gl_moveable=null;
		var gl_markermanager = null;
				
		//TRM.TargetPrefix = "";
		
		//Initialise the 'map' object
		function init() {
			
			//Main Map
			gl_map = new OpenLayers.Map("map", {
			controls: [
				//new OpenLayers.Control.KeyboardDefaults(),
				new OpenLayers.Control.MouseDefaults(),
				new OpenLayers.Control.LayerSwitcher(),
				new OpenLayers.Control.PanZoomBar()],
			maxExtent:
                new OpenLayers.Bounds(-20037508.34,-20037508.34,
                                       20037508.34, 20037508.34),
			numZoomLevels: 18,
            maxResolution: 156543,
            units: 'meters',
            projection: "EPSG:4326"} );
			
			layerMapnik = new OpenLayers.Layer.OSM.Mapnik("Mapnik");
			gl_map.addLayer(layerMapnik);
									
			layerCycleMap = new OpenLayers.Layer.OSM.CycleMap("CycleMap");
			gl_map.addLayer(layerCycleMap);
			gl_map.addControl(new OpenLayers.Control.MousePosition());
					
			gl_markers = new OpenLayers.Layer.Markers( "Markers",{projection: new OpenLayers.Projection("EPSG:4326")});
    		gl_map.addLayer(gl_markers);
			
			var pm = new PoiManager();
									
			//Client Application
			gl_application = new DijitClient2("osmdatamanager",gl_map);			
			//gl_application.disablePrivatemode();
						
			//Groupmanager
			gl_groupmanager = new Groupmanager(gl_application);	
			//gl_application.initGroupmanager(gl_groupmanager);
			gl_markermanager = new MarkerManager();
			gl_application.markermanager = gl_markermanager;
						
			//check if users is already logged in
			var cb = {
				func:gl_application._cb_loginUser,
				target:gl_application
			}
			gl_application.checkUser(cb);
			
			
			//dojo.connect(dojo.byId("dnd_source"), "onDndDrop", onDrop);
			/*		
			dojo.subscribe("/dnd/drop", function(source,nodes,iscopy){
  				
				var t = dojo.dnd.manager().target;
				//ClearMsg();	
				if(t == source) return;
				
				if (t) {
					
				}
				
				if (source) {
					console.debug(nodes[0].innerHTML);
					console.debug(iscopy);
					console.debug(source);
					//document.removeChild(nodes[0]);
				}
				
				dojo.dnd.manager().canDrop(false);
				});
			*/
			
			//dlg_filelist
			//gl_moveable = new dojo.dnd.Moveable("dlg_filelist");
			
			
			//tree test
			var store = new dojo.data.ItemFileReadStore({
		        url: "countries.json"
				//url: "filefunctions.php?action=msg.getfiles"
		    });
		
		    //var treeModel = new dijit.tree.ForestStoreModel({
			var treeModel = new my.ForestStoreModel({
		        store: store,
		        query: {"plugin_id":  '*' },
		        rootId: "root",
		        rootLabel: "Company",
		        childrenAttrs: ["children"]
		    });
		
		    new dijit.Tree({
		        model: treeModel,
		        dndController: "dijit._tree.dndSource"
		    }, "treeThree");

			
		}		
		
	</script>
</head>

<body class="tundra" >
	  <div id="overlay"><div class="innerOverlay">Loading please wait...</div></div>

	  <div dojoType="dijit.layout.BorderContainer" class="maincontent" design="sidebar" id="borderContainer">
	    	
		<!-- TOP Menu (general map options)  -->
		<div dojoType="dijit.layout.ContentPane" region="top" class="topmenu">						
				<button dojoType="dijit.form.Button" onclick="window.open('http://osmdatamanager.berlios.de/')">.:Project Page:.</button>
		</div>	
		
		<!-- MAIN MAP -->
		<div dojoType="dijit.layout.ContentPane" region="center" id="map">
		</div>
		
		<!-- LEFT MENU (user options or login) -->
		<div dojoType="dijit.layout.ContentPane" region="left" class="soria" id="mainmenu">
			<!-- <img src="images/bg_street_small.png"></img> -->
			<img src="images/logo4a.png" />
			
			<div style="width: 210px; height:400px; padding-top:8px;background-color:#fdd13a;" id="roundeddiv">
							
				<div class="custombutton1">								
					<button dojoType="trm.Button.TrmButton" id="btn_login" onclick="gl_application.showLogin()" field="login">Login</button>
					<button dojoType="trm.Button.TrmButton" onclick="gl_application.centerHomebase()" field="showhomebase">Heimatort anzeigen</button><br/>
				</div>
				
				<div><!--
					<div id="treecontainer" >
					</div>
					-->
					<div id="treeThree"></div>
				</div>
			</div>	
			
			<div style="margin-top:20px; font-size:10px; text-align:center;">
				powerd by
				<a href="http://developer.berlios.de" target="_blank" title="BerliOS Developer"> <img src="http://developer.berlios.de/bslogo.php?group_id=10678" style="margin-left:50px; padding:0px;" width="124px" height="32px" border="0" alt="BerliOS Developer Logo" /></a>
				<br/>
				
				<a href="http://www.openstreetmap.org" target="_blank">Openstreetmap<img src="images/Mag_map-120x120.png" style="cursor:pointer; margin-left:50px; border-style:none;" /></a>
			</div>
		</div>						
	  </div>  
	
	<div id="coords"></div>

	<!-- DIALOGS -->
	
	<!-- loading dialog -->
	<div dojoType="dijit.Dialog" class="soria" id="dialog_loading" closable="false" title="please wait">loading your gpx traces..</div>
	
	<!-- info dialog -->
	<div dojoType="dijit.Dialog" id="dialog_info" closable="false" title="">
		<div id="dlginfo_text">info</div>
		<button dojoType="dijit.form.Button" onclick="gl_application.hideMessageDialog()" id="btn_dlginfo_ok">Ok</button><br/>
	</div>
			
	  
 	<!-- login dialog -->
 	<div dojoType="trm.login.Form" id="dlg_login"></div> 
  
	<!-- Item Manager -->
	<div dojoType="trm.widget.ItemManager" id="dlg_itemmanager"></div>
	
	<!-- User Dialog -->
	<div dojoType="trm.widget.UserDialog" id="dlg_user"></div>
	
	
	<!-- Picture Dialog -->
	<div class="soria" dojoType="dijit.Dialog"  id="dlg_picturelist" title="Bild selektieren" closeable="false"
		execute="alert('submitted w/args:\n' + dojo.toJson(arguments[0], true));">
		<div id="thumbPicker1" dojoType="dojox.image.ThumbnailPicker"></div>
	</div>
	
	<!-- create group dialog -->
	<div dojoType="trm.widget.GroupDialog" id="dlg_group"></div>
	  
	<!-- Point Of Interest dialog -->
	<div dojoType="trm.widget.PoiDialog" id="dlg_poi"></div>
	
	<!-- Popup -->
	<div dojoType="dijit.Menu" id="trmPopup" onOpen="gl_application.groupTreeOpenmenu(this)" contextMenuForWindow="false" targetNodeIds="roundeddiv" style="display: none;" >
		<div dojoType="trm.MenuItem.TrmMenuItem" id="itm_loaddata" field="display" onClick="gl_application.displaySelected()">Anzeigen</div> 
		<div dojoType="trm.MenuItem.TrmMenuItem" id="itm_edit" field="edit" onClick="gl_application.showEdit()">Bearbeiten</div>		
	  	<div dojoType="trm.MenuItem.TrmMenuItem" id="itm_remove" field="remove" onClick="gl_application.doRemove()" >Entfernen</div>
		<div dojoType="dijit.MenuSeparator"></div>	
		<div dojoType="trm.MenuItem.TrmMenuItem" id="itm_manager" field="manager" onClick="gl_application.showItemManager()">Item Manager</div>
		<div dojoType="dijit.MenuSeparator"></div>	
		
		<!-- Groups -->  
		<div dojoType="dijit.PopupMenuItem" id="itm_submenu_groups">
			<span>Gruppen</span>
			<div dojoType="dijit.Menu" id="submenu_groups">
				<div dojoType="trm.MenuItem.TrmMenuItem" id="itm_createmaingroup" field="createrootgroup" onClick="gl_application.showGroupDialog(true,false)">Hauptgruppe hinzuf&uuml;gen</div>
				<div dojoType="trm.MenuItem.TrmMenuItem" id="itm_createsubgroup" field="createsubgroup" onClick="gl_application.showGroupDialog(false,false)">Untergruppe hinzuf&uuml;gen</div>
				<div dojoType="dijit.MenuSeparator"></div>	
				<div dojoType="trm.MenuItem.TrmMenuItem" id="itm_deletegroup" field="deletegroup" onClick="gl_application.doDelete()">Gruppe l&ouml;schen</div>		
			</div>
		</div>
		<div dojoType="dijit.MenuSeparator"></div>	
		<div dojoType="trm.MenuItem.TrmMenuItem" id="itm_delete" field="delete" onClick="">Entfernen</div>
		<div dojoType="dijit.MenuSeparator"></div>	
		<div dojoType="trm.MenuItem.TrmMenuItem" id="itm_removeall" field="clearmap" onClick="gl_application.clearMap()">Karte bereinigen</div>
		<div dojoType="trm.MenuItem.TrmMenuItem" id="itm_updatetree" field="updatetree" onClick="gl_groupmanager.getRootGroups()">Baum aktualisieren</div>				
		<div dojoType="dijit.MenuSeparator"></div>	
		
		<div dojoType="dijit.PopupMenuItem" id="itm_submenu_settings">
			<span>Einstellungen</span>
			<div dojoType="dijit.Menu" id="submenu_settings">
				<div dojoType="trm.MenuItem.TrmMenuItem" id="itm_usersettings" field="usersettings" onClick="gl_application.showUserDialog()">Benutzereinstellungen</div>
			</div>
		</div>
	</div>
      
	<!-- Dnd Source -->
	<div dojoType="dojo.dnd.Source" jsId="dnd_s1" id="dnd_source" class="dnd_source_hidden" copyOnly="true" dndType="dnd_source">
		<span class="dojoDndItem nodespan" dndType="red,darkred">
			<table>
				<tr>
					<td><img id="dnd_source_image" src="images/folder.png"></img></td>
					<td><!--<a id="dnd_source_text">please wait...</a>--></td>
				</tr>
			</table>
		</span>
	</div>
	
</body>
</html>
